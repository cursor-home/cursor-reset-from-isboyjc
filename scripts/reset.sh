#!/bin/bash

#############################################################
# Cursor ç¼–è¾‘å™¨è¯•ç”¨æœŸé‡ç½®å·¥å…· (Linux/macOS Shell ç‰ˆæœ¬)
# 
# åŠŸèƒ½ï¼šé€šè¿‡é‡ç½®è®¾å¤‡IDï¼Œé‡æ–°å¼€å§‹ Cursor ç¼–è¾‘å™¨çš„è¯•ç”¨æœŸ
# é€‚ç”¨ç³»ç»Ÿï¼šmacOS å’Œ Linux
# 
# ä½œè€…: @isboyjc
# åˆ›å»ºæ—¶é—´: 2024-06-01
# æœ€åŽæ›´æ–°: 2024-06-11
#############################################################

#################################################
# æ£€æŸ¥ Cursor æ˜¯å¦å·²å®‰è£…
# 
# æ ¹æ®ä¸åŒæ“ä½œç³»ç»Ÿæ£€æŸ¥ Cursor çš„é»˜è®¤å®‰è£…ä½ç½®
# - macOS: æ£€æŸ¥ /Applications/Cursor.app
# - Linux: æ£€æŸ¥å¤šä¸ªå¯èƒ½çš„å®‰è£…ä½ç½®
# 
# è¿”å›žå€¼ï¼šæ— ç›´æŽ¥è¿”å›žå€¼ï¼Œæœªå®‰è£…æ—¶è„šæœ¬ä¼šé€€å‡º
#################################################
check_cursor_installed() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOSç³»ç»Ÿï¼šCursoré€šå¸¸å®‰è£…åœ¨åº”ç”¨ç¨‹åºç›®å½•
        if [ ! -d "/Applications/Cursor.app" ]; then
            echo "âŒ æœªæ£€æµ‹åˆ° Cursor ç¼–è¾‘å™¨ï¼Œè¯·å…ˆå®‰è£… Cursorï¼"
            echo "ä¸‹è½½åœ°å€ï¼šhttps://www.cursor.com/downloads"
            exit 1
        fi
    elif [[ "$OSTYPE" == "linux"* ]]; then
        # Linuxç³»ç»Ÿï¼šCursorå¯èƒ½å®‰è£…åœ¨å¤šä¸ªä½ç½®ï¼Œéœ€è¦é€ä¸€æ£€æŸ¥
        if [ ! -d "/usr/share/cursor" ] && [ ! -d "/opt/cursor" ] && [ ! -d "$HOME/.local/share/cursor" ]; then
            echo "âŒ æœªæ£€æµ‹åˆ° Cursor ç¼–è¾‘å™¨ï¼Œè¯·å…ˆå®‰è£… Cursorï¼"
            echo "ä¸‹è½½åœ°å€ï¼šhttps://www.cursor.com/downloads"
            exit 1
        fi
    fi
    echo "âœ… Cursor ç¼–è¾‘å™¨å·²å®‰è£…"
}

#################################################
# æ£€æŸ¥ Cursor æ˜¯å¦åœ¨è¿è¡Œ
# 
# æ ¹æ®ä¸åŒæ“ä½œç³»ç»Ÿä½¿ç”¨ä¸åŒçš„å‘½ä»¤æ£€æŸ¥è¿›ç¨‹
# - macOS: ä½¿ç”¨ pgrep å‘½ä»¤æŸ¥æ‰¾ Cursor å’Œ Cursor Helper è¿›ç¨‹
# - Linux: ä½¿ç”¨ pgrep å‘½ä»¤æŸ¥æ‰¾ cursor å’Œ Cursor è¿›ç¨‹
# 
# è¿”å›žå€¼: å¦‚æžœ Cursor æ­£åœ¨è¿è¡Œè¿”å›ž0(true)ï¼Œå¦åˆ™è¿”å›žéž0å€¼(false)
#################################################
check_cursor_running() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOSç³»ç»Ÿä¸‹ä½¿ç”¨ pgrep å‘½ä»¤æ£€æŸ¥ Cursor è¿›ç¨‹
        # -x å‚æ•°è¦æ±‚è¿›ç¨‹åå®Œå…¨åŒ¹é…ï¼Œ|| è¡¨ç¤ºå¦‚æžœç¬¬ä¸€ä¸ªå‘½ä»¤å¤±è´¥ï¼Œå°è¯•ç¬¬äºŒä¸ª
        pgrep -x "Cursor" > /dev/null || pgrep -x "Cursor Helper" > /dev/null
    elif [[ "$OSTYPE" == "linux"* ]]; then
        # Linuxç³»ç»Ÿä¸‹ä½¿ç”¨ pgrep å‘½ä»¤æ£€æŸ¥ cursor è¿›ç¨‹
        # åŒæ—¶æ£€æŸ¥ "cursor" å’Œ "Cursor"ï¼ˆè€ƒè™‘å¤§å°å†™ï¼‰
        pgrep -x "cursor" > /dev/null || pgrep -x "Cursor" > /dev/null
    fi
    # å‡½æ•°ä¼šè¿”å›žæœ€åŽä¸€ä¸ªå‘½ä»¤çš„é€€å‡ºçŠ¶æ€
    # pgrep å‘½ä»¤æ‰¾åˆ°è¿›ç¨‹æ—¶è¿”å›ž 0ï¼Œæœªæ‰¾åˆ°æ—¶è¿”å›žéž 0
}

#################################################
# å…³é—­ Cursor è¿›ç¨‹
# 
# æ ¹æ®ä¸åŒæ“ä½œç³»ç»Ÿä½¿ç”¨ç›¸åº”çš„å‘½ä»¤å…³é—­è¿›ç¨‹
# - macOS: ä½¿ç”¨pkillå‘½ä»¤å‘é€SIGKILLä¿¡å·å¼ºåˆ¶ç»“æŸè¿›ç¨‹
# - Linux: ä½¿ç”¨pkillå‘½ä»¤å‘é€SIGKILLä¿¡å·å¼ºåˆ¶ç»“æŸè¿›ç¨‹
# 
# è¿”å›žå€¼: æ— 
#################################################
kill_cursor_process() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOSç³»ç»Ÿä¸‹ä½¿ç”¨pkillå‘½ä»¤ï¼Œ-9è¡¨ç¤ºå‘é€SIGKILLä¿¡å·ï¼ˆå¼ºåˆ¶ç»ˆæ­¢ï¼‰
        pkill -9 "Cursor"
    elif [[ "$OSTYPE" == "linux"* ]]; then
        # Linuxç³»ç»Ÿä¸‹ä½¿ç”¨pkillå‘½ä»¤
        pkill -9 "cursor"
    fi
    # ç­‰å¾…1.5ç§’ï¼Œè®©è¿›ç¨‹æœ‰æ—¶é—´å®Œå…¨é€€å‡º
    sleep 1.5
}

#################################################
# èŽ·å–é…ç½®æ–‡ä»¶è·¯å¾„
# 
# æ ¹æ®ä¸åŒæ“ä½œç³»ç»Ÿè¿”å›žé…ç½®æ–‡ä»¶çš„æ ‡å‡†ä½ç½®ï¼š
# - macOS: ~/Library/Application Support/Cursor
# - Linux: ~/.config/Cursor
# 
# è¿”å›žå€¼: é…ç½®ç›®å½•çš„å®Œæ•´è·¯å¾„
#################################################
get_config_dir() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOSä¸‹é…ç½®ç›®å½•ä½äºŽç”¨æˆ·çš„Library/Application Supportç›®å½•ä¸­
        echo "$HOME/Library/Application Support/Cursor"
    elif [[ "$OSTYPE" == "linux"* ]]; then
        # Linuxä¸‹é…ç½®ç›®å½•ä½äºŽç”¨æˆ·çš„.configç›®å½•ä¸­
        echo "$HOME/.config/Cursor"
    else
        # ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ
        echo "âŒ ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ"
        exit 1
    fi
}

#################################################
# ç”Ÿæˆéšæœºè®¾å¤‡ ID
# 
# æ ¹æ®ä¸åŒæ“ä½œç³»ç»Ÿä½¿ç”¨ä¸åŒçš„å‘½ä»¤ç”ŸæˆUUIDï¼š
# - macOS: ä½¿ç”¨uuidgenå‘½ä»¤
# - Linux: ä½¿ç”¨/proc/sys/kernel/random/uuidæ–‡ä»¶
# 
# è¿”å›žå€¼: ç”Ÿæˆçš„UUIDå­—ç¬¦ä¸²
#################################################
generate_device_id() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOSç³»ç»Ÿä½¿ç”¨uuidgenå‘½ä»¤ç”ŸæˆUUID
        echo $(uuidgen)
    else
        # Linuxç³»ç»Ÿä»Ž/proc/sys/kernel/random/uuidæ–‡ä»¶è¯»å–UUID
        # è¯¥æ–‡ä»¶æ¯æ¬¡è¯»å–æ—¶ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„éšæœºUUID
        echo $(cat /proc/sys/kernel/random/uuid)
    fi
}

#################################################
# å¤‡ä»½é…ç½®æ–‡ä»¶
# 
# åˆ›å»ºé…ç½®æ–‡ä»¶çš„æ—¶é—´æˆ³å¤‡ä»½ï¼Œæ–‡ä»¶åæ ¼å¼ä¸ºï¼šåŽŸæ–‡ä»¶å.æ—¶é—´æˆ³.bak
# 
# å‚æ•°:
#   $1 - éœ€è¦å¤‡ä»½çš„æ–‡ä»¶è·¯å¾„
# 
# è¿”å›žå€¼: å¤‡ä»½æ–‡ä»¶çš„å®Œæ•´è·¯å¾„
#################################################
backup_config() {
    local config_file="$1"
    # ç”Ÿæˆæ—¶é—´æˆ³ï¼Œæ ¼å¼ä¸ºå¹´æœˆæ—¥æ—¶åˆ†ç§’æ¯«ç§’
    local timestamp=$(date +"%Y%m%d%H%M%S%3N")
    # æž„å»ºå¤‡ä»½æ–‡ä»¶è·¯å¾„
    local backup_file="${config_file}.${timestamp}.bak"
    # å¤åˆ¶åŽŸæ–‡ä»¶åˆ°å¤‡ä»½è·¯å¾„
    cp "$config_file" "$backup_file"
    # è¿”å›žå¤‡ä»½æ–‡ä»¶çš„å®Œæ•´è·¯å¾„
    echo "$backup_file"
}

#################################################
# ç¦ç”¨ Cursor è‡ªåŠ¨æ›´æ–°
# 
# é€šè¿‡åˆ é™¤æ›´æ–°ç›®å½•å¹¶åˆ›å»ºåŒåæ–‡ä»¶æ¥é˜»æ­¢æ›´æ–°ç¨‹åºè¿è¡Œ
# è¿™æ ·å¯ä»¥é˜²æ­¢Cursorè‡ªåŠ¨æ›´æ–°åˆ°æ–°ç‰ˆæœ¬ï¼Œé¿å…é‡ç½®å¤±æ•ˆ
# 
# è¿”å›žå€¼: æˆåŠŸè¿”å›ž0ï¼Œå¤±è´¥è¿”å›ž1
#################################################
disable_cursor_update() {
    local updater_path=""
    # æ ¹æ®ä¸åŒæ“ä½œç³»ç»Ÿï¼Œç¡®å®šæ›´æ–°ç¨‹åºçš„è·¯å¾„
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOSä¸‹æ›´æ–°ç¨‹åºè·¯å¾„
        updater_path="$HOME/Library/Application Support/Caches/cursor-updater"
    elif [[ "$OSTYPE" == "linux"* ]]; then
        # Linuxä¸‹æ›´æ–°ç¨‹åºè·¯å¾„
        updater_path="$HOME/.config/cursor-updater"
    else
        # ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ
        echo "âŒ ä¸æ”¯æŒçš„æ“ä½œç³»ç»Ÿ"
        return 1
    fi

    # å¦‚æžœå­˜åœ¨ç›®å½•æˆ–æ–‡ä»¶ï¼Œå…ˆåˆ é™¤
    if [ -e "$updater_path" ]; then
        rm -rf "$updater_path"
    fi

    # åˆ›å»ºç©ºæ–‡ä»¶æ¥é˜»æ­¢æ›´æ–°
    # è¿™ä¼šé˜»æ­¢æ›´æ–°ç¨‹åºåˆ›å»ºåŒåç›®å½•ï¼Œä»Žè€Œç¦ç”¨è‡ªåŠ¨æ›´æ–°
    touch "$updater_path"
    # æ£€æŸ¥touchå‘½ä»¤çš„é€€å‡ºçŠ¶æ€
    if [ $? -eq 0 ]; then
        return 0
    else
        return 1
    fi
}

#################################################
# ä¸»ç¨‹åºå‡½æ•°
# 
# æ‰§è¡Œå®Œæ•´çš„é‡ç½®æµç¨‹ï¼š
# 1. æ£€æŸ¥ Cursor å®‰è£…çŠ¶æ€
# 2. æ£€æŸ¥å¹¶å…³é—­è¿è¡Œä¸­çš„ Cursor è¿›ç¨‹
# 3. å‡†å¤‡é…ç½®ç›®å½•
# 4. å¤‡ä»½çŽ°æœ‰é…ç½®
# 5. ç”Ÿæˆæ–°çš„è®¾å¤‡ ID
# 6. ä¿å­˜æ–°é…ç½®
# 7. ç¦ç”¨è‡ªåŠ¨æ›´æ–°
#################################################
main() {
    # ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥ Cursor ç¼–è¾‘å™¨æ˜¯å¦å·²å®‰è£…
    echo "ðŸ” æ­£åœ¨æ£€æŸ¥ Cursor ç¼–è¾‘å™¨..."
    check_cursor_installed
    echo

    # ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥ Cursor æ˜¯å¦æ­£åœ¨è¿è¡Œï¼Œå¦‚æžœæ˜¯åˆ™æç¤ºç”¨æˆ·å…³é—­
    echo "ðŸ” æ£€æŸ¥ Cursor æ˜¯å¦åœ¨è¿è¡Œ..."
    if check_cursor_running; then
        # Cursor æ­£åœ¨è¿è¡Œï¼Œè¯¢é—®ç”¨æˆ·æ˜¯å¦è‡ªåŠ¨å…³é—­
        echo "æ£€æµ‹åˆ° Cursor æ­£åœ¨è¿è¡Œï¼Œæ˜¯å¦è‡ªåŠ¨å…³é—­ï¼Ÿ (y/N): "
        read -r response
        if [[ "$response" =~ ^[Yy]$ ]]; then
            # ç”¨æˆ·åŒæ„è‡ªåŠ¨å…³é—­ï¼Œå°è¯•å…³é—­è¿›ç¨‹
            echo "æ­£åœ¨å…³é—­ Cursor..."
            kill_cursor_process
            # å†æ¬¡æ£€æŸ¥è¿›ç¨‹æ˜¯å¦è¿˜åœ¨è¿è¡Œ
            if check_cursor_running; then
                # è¿›ç¨‹ä»åœ¨è¿è¡Œï¼Œæ— æ³•è‡ªåŠ¨å…³é—­
                echo "âŒ æ— æ³•è‡ªåŠ¨å…³é—­ Cursorï¼Œè¯·æ‰‹åŠ¨å…³é—­åŽé‡è¯•ï¼"
                exit 1
            fi
            echo "âœ… Cursor å·²æˆåŠŸå…³é—­"
        else
            # ç”¨æˆ·ä¸åŒæ„è‡ªåŠ¨å…³é—­ï¼Œæç¤ºæ‰‹åŠ¨å…³é—­åŽé‡è¯•
            echo "âŒ è¯·å…ˆå…³é—­ Cursor ç¼–è¾‘å™¨åŽå†è¿è¡Œæ­¤å·¥å…·ï¼"
            exit 1
        fi
    else
        # Cursor æœªè¿è¡Œï¼Œå¯ä»¥ç»§ç»­
        echo "âœ… Cursor ç¼–è¾‘å™¨å·²å…³é—­"
    fi
    echo

    # ç¬¬ä¸‰æ­¥ï¼šå‡†å¤‡é…ç½®ç›®å½•å’Œæ–‡ä»¶è·¯å¾„
    CONFIG_DIR=$(get_config_dir)
    STORAGE_FILE="$CONFIG_DIR/User/globalStorage/storage.json"
    
    echo "ðŸ“‚ æ­£åœ¨å‡†å¤‡é…ç½®æ–‡ä»¶..."
    # é€’å½’åˆ›å»ºé…ç½®æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•æ ‘
    mkdir -p "$(dirname "$STORAGE_FILE")"
    echo "âœ… é…ç½®ç›®å½•åˆ›å»ºæˆåŠŸ"
    echo

    # ç¬¬å››æ­¥ï¼šå¤‡ä»½çŽ°æœ‰é…ç½®æ–‡ä»¶ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
    if [ -f "$STORAGE_FILE" ]; then
        echo "ðŸ’¾ æ­£åœ¨å¤‡ä»½åŽŸé…ç½®..."
        BACKUP_FILE=$(backup_config "$STORAGE_FILE")
        # åªæ˜¾ç¤ºå¤‡ä»½æ–‡ä»¶çš„æ–‡ä»¶åï¼Œè€Œéžå®Œæ•´è·¯å¾„
        echo "âœ… é…ç½®å¤‡ä»½å®Œæˆï¼Œå¤‡ä»½æ–‡ä»¶è·¯å¾„ï¼š$(basename "$BACKUP_FILE")"
        echo
    fi

    # ç¬¬äº”æ­¥ï¼šç”Ÿæˆæ–°çš„éšæœºè®¾å¤‡ID
    echo "ðŸŽ² æ­£åœ¨ç”Ÿæˆæ–°çš„è®¾å¤‡ ID..."
    MACHINE_ID=$(generate_device_id)
    MAC_MACHINE_ID=$(generate_device_id)
    DEV_DEVICE_ID=$(generate_device_id)

    # ç¬¬å…­æ­¥ï¼šåˆ›å»ºæ–°çš„é…ç½®å¯¹è±¡å¹¶ä¿å­˜åˆ°æ–‡ä»¶
    # ä½¿ç”¨Here Document (EOF)åˆ›å»ºJSONæ ¼å¼çš„é…ç½®æ–‡ä»¶
    cat > "$STORAGE_FILE" << EOF
{
  "telemetry.machineId": "${MACHINE_ID}",
  "telemetry.macMachineId": "${MAC_MACHINE_ID}",
  "telemetry.devDeviceId": "${DEV_DEVICE_ID}"
}
EOF

    echo "âœ… æ–°è®¾å¤‡ ID ç”ŸæˆæˆåŠŸ"
    echo
    echo "ðŸ’¾ æ­£åœ¨ä¿å­˜æ–°é…ç½®..."
    echo "âœ… æ–°é…ç½®ä¿å­˜æˆåŠŸ"
    echo
    echo "ðŸŽ‰ è®¾å¤‡ ID é‡ç½®æˆåŠŸï¼æ–°çš„è®¾å¤‡ ID ä¸ºï¼š"
    echo
    # æ˜¾ç¤ºä¿å­˜çš„é…ç½®æ–‡ä»¶å†…å®¹
    cat "$STORAGE_FILE"
    echo
    echo "ðŸ“ é…ç½®æ–‡ä»¶è·¯å¾„ï¼š$STORAGE_FILE"
    echo

    # ç¬¬ä¸ƒæ­¥ï¼šç¦ç”¨Cursorè‡ªåŠ¨æ›´æ–°åŠŸèƒ½
    echo "ðŸ”„ æ­£åœ¨ç¦ç”¨è‡ªåŠ¨æ›´æ–°..."
    if disable_cursor_update; then
        echo "âœ… è‡ªåŠ¨æ›´æ–°å·²æˆåŠŸç¦ç”¨"
    else
        echo "âŒ ç¦ç”¨è‡ªåŠ¨æ›´æ–°å¤±è´¥"
    fi

    # å®Œæˆå¹¶æ˜¾ç¤ºæç¤ºä¿¡æ¯
    echo
    echo "âœ¨ çŽ°åœ¨å¯ä»¥å¯åŠ¨ Cursor ç¼–è¾‘å™¨äº†"
    echo "âš ï¸ æç¤ºï¼šå·²ç¦ç”¨è‡ªåŠ¨æ›´æ–°ï¼Œå¦‚éœ€æ›´æ–°è¯·æ‰‹åŠ¨ä¸‹è½½æ–°ç‰ˆæœ¬"
}

# æ‰§è¡Œä¸»ç¨‹åº
main
